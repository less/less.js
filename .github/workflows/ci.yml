# Github actions workflow name
name: CI

# Triggers the workflow on push or pull request events
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  basic_node_test:
    name: 'Basic tests on ubuntu-latest with nodejs v22 (current LTS version)'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 8
    - uses: actions/setup-node@v4
      with:
        node-version: 22
        cache: 'pnpm'
    - name: Install dependencies
      run: pnpm install
    - name: Print put node & npm version
      run: node --version && pnpm --version 
    - name: Install chromium
      run: npx playwright install chromium
    - name: Run unit test
      run: pnpm run test

  windows_and_macos_test:
    name: 'Platform tests on ${{matrix.os}} with nodejs v${{matrix.node}}'
    needs: basic_node_test
    strategy:
      matrix:
        # Test all mainstream operating system
        os: [macos-latest, windows-latest]
        node: [22]
    runs-on: ${{ matrix.os }}
    # This has copy/paste steps and should be refactored using DRY
    steps:
    - uses: actions/checkout@v4
    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 8
    - uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node }}
        cache: 'pnpm'
    - name: Install dependencies
      run: pnpm install
    - name: Print put node & npm version
      run: node --version && pnpm --version 
    - name: Install chromium
      run: npx playwright install chromium
    - name: Run unit test
      run: pnpm run test

  historical_versions_node_test:
    name: 'Historical version nodejs v${{matrix.node}} test'
    needs: basic_node_test
    strategy:
      matrix:
        os: [ubuntu-latest]
        node: [14, 16, 18, 20]
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v4
    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 8
    - uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node }}
        cache: 'pnpm'
    - name: Install dependencies
      run: pnpm install
    - name: Print put node & npm version
      run: node --version && pnpm --version 
    - name: Install chromium
      run: npx playwright install chromium
    - name: Run unit test
      run: pnpm run test

  # Why so much copy / paste? Refactor this
  latest_nodejs_testing_node23:
    name: 'Latest nodejs v23 test'
    needs: basic_node_test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 8
    - uses: actions/setup-node@v4
      with:
        node-version: 23
        cache: 'pnpm'
    - name: Install dependencies
      run: pnpm install
    - name: Print put node & npm version
      run: node --version && pnpm --version 
    - name: Install chromium
      run: npx playwright install chromium
    - name: Run unit test
      run: pnpm run test
